<!DOCTYPE html>

<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width">
	<title>佐々木興行ドメインライブラリ for node.js Source: service/interpreter/transaction.js</title>

	<!--[if lt IE 9]>
	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<link type="text/css" rel="stylesheet" href="styles/sunlight.default.css">

	<link type="text/css" rel="stylesheet" href="styles/site.cosmo.css">

</head>

<body>

<div class="navbar navbar-default navbar-fixed-top navbar-inverse">
<div class="container">
	<div class="navbar-header">
		<a class="navbar-brand" href="index.html">佐々木興行ドメインライブラリ for node.js</a>
		<button class="navbar-toggle" type="button" data-toggle="collapse" data-target="#topNavigation">
			<span class="icon-bar"></span>
			<span class="icon-bar"></span>
			<span class="icon-bar"></span>
        </button>
	</div>
	<div class="navbar-collapse collapse" id="topNavigation">
		<ul class="nav navbar-nav">
			
			<li class="dropdown">
				<a href="namespaces.list.html" class="dropdown-toggle" data-toggle="dropdown">Namespaces<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="AssetFactory.html">AssetFactory</a></li><li><a href="AssetGroup.html">AssetGroup</a></li><li><a href="AuthorizationFactory.html">AuthorizationFactory</a></li><li><a href="AuthorizationGroup.html">AuthorizationGroup</a></li><li><a href="FilmFactory.html">FilmFactory</a></li><li><a href="NotificationFactory.html">NotificationFactory</a></li><li><a href="NotificationGroup.html">NotificationGroup</a></li><li><a href="ObjectIdFactory.html">ObjectIdFactory</a></li><li><a href="OwnerFactory.html">OwnerFactory</a></li><li><a href="OwnerGroup.html">OwnerGroup</a></li><li><a href="OwnershipFactory.html">OwnershipFactory</a></li><li><a href="PerformanceFactory.html">PerformanceFactory</a></li><li><a href="QueueFactory.html">QueueFactory</a></li><li><a href="QueueGroup.html">QueueGroup</a></li><li><a href="QueueStatus.html">QueueStatus</a></li><li><a href="ScreenFactory.html">ScreenFactory</a></li><li><a href="TheaterFactory.html">TheaterFactory</a></li><li><a href="TransactionEventFactory.html">TransactionEventFactory</a></li><li><a href="TransactionEventGroup.html">TransactionEventGroup</a></li><li><a href="TransactionFactory.html">TransactionFactory</a></li><li><a href="TransactionInquiryKeyFactory.html">TransactionInquiryKeyFactory</a></li><li><a href="TransactionQueuesStatus.html">TransactionQueuesStatus</a></li><li><a href="TransactionStatus.html">TransactionStatus</a></li>
				</ul>
			</li>
			
			<li class="dropdown">
				<a href="classes.list.html" class="dropdown-toggle" data-toggle="dropdown">Classes<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="AnonymousOwner.html">AnonymousOwner</a></li><li><a href="AnonymousOwner.AnonymousOwner.html">AnonymousOwner.AnonymousOwner</a></li><li><a href="Asset.html">Asset</a></li><li><a href="AssetAuthorization.html">AssetAuthorization</a></li><li><a href="AssetAuthorization.AssetAuthorization.html">AssetAuthorization.AssetAuthorization</a></li><li><a href="Authorization.html">Authorization</a></li><li><a href="AuthorizeTransactionEvent.html">AuthorizeTransactionEvent</a></li><li><a href="AuthorizeTransactionEvent.AuthorizeTransactionEvent.html">AuthorizeTransactionEvent.AuthorizeTransactionEvent</a></li><li><a href="CancelAuthorizationQueue.html">CancelAuthorizationQueue</a></li><li><a href="CancelAuthorizationQueue.CancelAuthorizationQueue.html">CancelAuthorizationQueue.CancelAuthorizationQueue</a></li><li><a href="COASeatReservationAuthorization.html">COASeatReservationAuthorization</a></li><li><a href="COASeatReservationAuthorization.COASeatReservationAuthorization.html">COASeatReservationAuthorization.COASeatReservationAuthorization</a></li><li><a href="DisableTransactionInquiryQueue.html">DisableTransactionInquiryQueue</a></li><li><a href="DisableTransactionInquiryQueue.DisableTransactionInquiryQueue.html">DisableTransactionInquiryQueue.DisableTransactionInquiryQueue</a></li><li><a href="EmailNotification.html">EmailNotification</a></li><li><a href="EmailNotification.EmailNotification.html">EmailNotification.EmailNotification</a></li><li><a href="Film.html">Film</a></li><li><a href="GMOAuthorization.html">GMOAuthorization</a></li><li><a href="GMOAuthorization.GMOAuthorization.html">GMOAuthorization.GMOAuthorization</a></li><li><a href="MasterServiceInterpreter.html">MasterServiceInterpreter</a></li><li><a href="MemberOwner.html">MemberOwner</a></li><li><a href="MemberOwner.MemberOwner.html">MemberOwner.MemberOwner</a></li><li><a href="Notification.html">Notification</a></li><li><a href="NotificationAddTransactionEvent.html">NotificationAddTransactionEvent</a></li><li><a href="NotificationRemoveTransactionEvent.html">NotificationRemoveTransactionEvent</a></li><li><a href="NotificationRemoveTransactionEvent.NotificationRemoveTransactionEvent.html">NotificationRemoveTransactionEvent.NotificationRemoveTransactionEvent</a></li><li><a href="NotificationServiceInterpreter.html">NotificationServiceInterpreter</a></li><li><a href="Owner.html">Owner</a></li><li><a href="Ownership.html">Ownership</a></li><li><a href="Performance.html">Performance</a></li><li><a href="PromoterOwner.html">PromoterOwner</a></li><li><a href="PromoterOwner.PromoterOwner.html">PromoterOwner.PromoterOwner</a></li><li><a href="PushNotificationQueue.html">PushNotificationQueue</a></li><li><a href="PushNotificationQueue.PushNotificationQueue.html">PushNotificationQueue.PushNotificationQueue</a></li><li><a href="Queue.html">Queue</a></li><li><a href="SalesServiceInterpreter.html">SalesServiceInterpreter</a></li><li><a href="Screen.html">Screen</a></li><li><a href="SeatReservationAsset.html">SeatReservationAsset</a></li><li><a href="SeatReservationAsset.SeatReservationAsset.html">SeatReservationAsset.SeatReservationAsset</a></li><li><a href="SettleAuthorizationQueue.html">SettleAuthorizationQueue</a></li><li><a href="SettleAuthorizationQueue.SettleAuthorizationQueue.html">SettleAuthorizationQueue.SettleAuthorizationQueue</a></li><li><a href="StockServiceInterpreter.html">StockServiceInterpreter</a></li><li><a href="Theater.html">Theater</a></li><li><a href="Transaction.html">Transaction</a></li><li><a href="TransactionEvent.html">TransactionEvent</a></li><li><a href="TransactionInquiryKey.html">TransactionInquiryKey</a></li><li><a href="TransactionServiceInterpreter.html">TransactionServiceInterpreter</a></li><li><a href="Unauthorize.html">Unauthorize</a></li><li><a href="Unauthorize.Unauthorize.html">Unauthorize.Unauthorize</a></li>
				</ul>
			</li>
			
			<li class="dropdown">
				<a href="global.html" class="dropdown-toggle" data-toggle="dropdown">Global<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="global.html#createAnonymous">createAnonymous</a></li><li><a href="global.html#createMasterService">createMasterService</a></li><li><a href="global.html#createOwnerRepository">createOwnerRepository</a></li>
				</ul>
			</li>
			
		</ul>
        
            <div class="col-sm-3 col-md-3">
                <form class="navbar-form" role="search">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Search" name="q" id="search-input">
                        <div class="input-group-btn">
                            <button class="btn btn-default" id="search-submit"><i class="glyphicon glyphicon-search"></i></button>
                        </div>
                    </div>
                </form>
            </div>
        
	</div>

</div>
</div>


<div class="container" id="toc-content">
<div class="row">

	
	<div class="col-md-12">
	
		<div id="main">
			

		<h1 class="page-title">Source: service/interpreter/transaction.js</h1>
    
<section>
    <article>
        <pre
            class="sunlight-highlight-javascript linenums">"use strict";
var __awaiter = (this &amp;&amp; this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
const objectId_1 = require("../../model/objectId");
const ownerGroup_1 = require("../../model/ownerGroup");
const queueStatus_1 = require("../../model/queueStatus");
const transactionEventGroup_1 = require("../../model/transactionEventGroup");
const transactionStatus_1 = require("../../model/transactionStatus");
const NotificationFactory = require("../../factory/notification");
const OwnerFactory = require("../../factory/owner");
const QueueFactory = require("../../factory/queue");
const TransactionFactory = require("../../factory/transaction");
const TransactionEventFactory = require("../../factory/transactionEvent");
/**
 * 取引サービス
 *
 * @class TransactionServiceInterpreter
 * @implements {TransactionService}
 */
class TransactionServiceInterpreter {
    /**
     * 匿名所有者更新
     *
     * @returns {OwnerAndTransactionOperation&lt;void>}
     *
     * @memberOf TransactionServiceInterpreter
     */
    updateAnonymousOwner(args) {
        return (ownerRepo, transactionRepo) => __awaiter(this, void 0, void 0, function* () {
            // 取引取得
            const optionTransaction = yield transactionRepo.findById(objectId_1.default(args.transaction_id));
            if (optionTransaction.isEmpty) {
                throw new Error(`transaction[${objectId_1.default(args.transaction_id)}] not found.`);
            }
            const transaction = optionTransaction.get();
            const anonymousOwner = transaction.owners.find((owner) => {
                return (owner.group === ownerGroup_1.default.ANONYMOUS);
            });
            if (!anonymousOwner) {
                throw new Error("anonymous owner not found.");
            }
            // 永続化
            const option = yield ownerRepo.findOneAndUpdate({
                _id: anonymousOwner._id
            }, {
                $set: {
                    name_first: args.name_first,
                    name_last: args.name_last,
                    email: args.email,
                    tel: args.tel
                }
            });
            if (option.isEmpty) {
                throw new Error("owner not found.");
            }
        });
    }
    /**
     * IDから取得する
     *
     * @param {string} transactionId
     * @returns {TransactionOperation&lt;monapt.Option&lt;Transaction>>}
     *
     * @memberOf TransactionServiceInterpreter
     */
    findById(transactionId) {
        return (transactionRepo) => __awaiter(this, void 0, void 0, function* () {
            return yield transactionRepo.findById(objectId_1.default(transactionId));
        });
    }
    /**
     * 取引開始
     *
     * @param {Date} expiredAt
     * @returns {OwnerAndTransactionOperation&lt;Transaction>}
     *
     * @memberOf TransactionServiceInterpreter
     */
    start(expiredAt) {
        return (ownerRepo, transactionRepo) => __awaiter(this, void 0, void 0, function* () {
            // 一般所有者作成
            const anonymousOwner = OwnerFactory.createAnonymous({
                _id: objectId_1.default()
            });
            // 興行主取得
            const option = yield ownerRepo.findPromoter();
            if (option.isEmpty) {
                throw new Error("promoter not found.");
            }
            const promoter = option.get();
            // イベント作成
            const event = TransactionEventFactory.create({
                _id: objectId_1.default(),
                group: transactionEventGroup_1.default.START,
                occurred_at: new Date()
            });
            // 取引作成
            const transaction = TransactionFactory.create({
                _id: objectId_1.default(),
                status: transactionStatus_1.default.UNDERWAY,
                events: [event],
                owners: [promoter, anonymousOwner],
                expired_at: expiredAt
            });
            // 永続化
            yield ownerRepo.store(anonymousOwner);
            yield transactionRepo.store(transaction);
            return transaction;
        });
    }
    /**
     * GMO資産承認
     *
     * @param {string} transactionId
     * @param {GMOAuthorization} authorization
     * @returns {TransactionOperation&lt;void>}
     *
     * @memberOf TransactionServiceInterpreter
     */
    addGMOAuthorization(transactionId, authorization) {
        return (transactionRepo) => __awaiter(this, void 0, void 0, function* () {
            // 取引取得
            const optionTransaction = yield transactionRepo.findById(objectId_1.default(transactionId));
            if (optionTransaction.isEmpty) {
                throw new Error(`transaction[${objectId_1.default(transactionId)}] not found.`);
            }
            const transaction = optionTransaction.get();
            // 所有者が取引に存在するかチェック
            const ownerIds = transaction.owners.map((owner) => {
                return owner._id.toString();
            });
            if (ownerIds.indexOf(authorization.owner_from.toString()) &lt; 0) {
                throw new Error(`transaction[${transactionId}] does not contain a owner[${authorization.owner_from}].`);
            }
            if (ownerIds.indexOf(authorization.owner_to.toString()) &lt; 0) {
                throw new Error(`transaction[${transactionId}] does not contain a owner[${authorization.owner_to}].`);
            }
            // 永続化
            yield this.pushAuthorization(transactionId, authorization)(transactionRepo);
            // return authorization;
        });
    }
    /**
     * COA資産承認
     *
     * @param {string} transactionId
     * @param {COASeatReservationAuthorization} authorization
     * @returns {OwnerAndTransactionOperation&lt;void>}
     *
     * @memberOf TransactionServiceInterpreter
     */
    addCOASeatReservationAuthorization(transactionId, authorization) {
        return (transactionRepo) => __awaiter(this, void 0, void 0, function* () {
            // 取引取得
            const optionTransaction = yield transactionRepo.findById(objectId_1.default(transactionId));
            if (optionTransaction.isEmpty) {
                throw new Error(`transaction[${objectId_1.default(transactionId)}] not found.`);
            }
            const transaction = optionTransaction.get();
            const ownerIds = transaction.owners.map((owner) => {
                return owner._id.toString();
            });
            if (ownerIds.indexOf(authorization.owner_from.toString()) &lt; 0) {
                throw new Error(`transaction[${transactionId}] does not contain a owner[${authorization.owner_from}].`);
            }
            if (ownerIds.indexOf(authorization.owner_to.toString()) &lt; 0) {
                throw new Error(`transaction[${transactionId}] does not contain a owner[${authorization.owner_to}].`);
            }
            // 永続化
            yield this.pushAuthorization(transactionId, authorization)(transactionRepo);
            // return authorization;
        });
    }
    /**
     * 資産承認解除
     *
     * @param {string} transactionId
     * @param {string} authorizationId
     * @returns {TransactionOperation&lt;void>}
     *
     * @memberOf TransactionServiceInterpreter
     */
    removeAuthorization(transactionId, authorizationId) {
        return (transactionRepo) => __awaiter(this, void 0, void 0, function* () {
            // 取引取得
            const optionTransacton = yield transactionRepo.findById(objectId_1.default(transactionId));
            if (optionTransacton.isEmpty) {
                throw new Error("tranasction not found.");
            }
            const transaction = optionTransacton.get();
            const authorizations = transaction.authorizations();
            const removedAuthorization = authorizations.find((authorization) => {
                return (authorization._id.toString() === authorizationId);
            });
            if (!removedAuthorization) {
                throw new Error(`authorization [${authorizationId}] not found in the transaction.`);
            }
            // イベント作成
            const event = TransactionEventFactory.createUnauthorize({
                _id: objectId_1.default(),
                occurred_at: new Date(),
                authorization: removedAuthorization
            });
            // 永続化
            const option = yield transactionRepo.findOneAndUpdate({
                _id: objectId_1.default(transactionId),
                status: transactionStatus_1.default.UNDERWAY
            }, {
                $push: {
                    events: event
                }
            });
            if (option.isEmpty) {
                throw new Error("UNDERWAY transaction not found.");
            }
        });
    }
    /**
     * 照合を可能にする
     *
     * @param {string} transactionId
     * @param {TransactionInquiryKey} key
     * @returns {TransactionOperation&lt;monapt.Option&lt;Transaction>>}
     *
     * @memberOf TransactionServiceInterpreter
     */
    enableInquiry(transactionId, key) {
        return (transactionRepo) => __awaiter(this, void 0, void 0, function* () {
            // 永続化
            const option = yield transactionRepo.findOneAndUpdate({
                _id: objectId_1.default(transactionId),
                status: transactionStatus_1.default.UNDERWAY
            }, {
                $set: {
                    inquiry_key: key
                }
            });
            if (option.isEmpty) {
                throw new Error("UNDERWAY transaction not found.");
            }
        });
    }
    /**
     * 照会する
     *
     * @param {TransactionInquiryKey} key
     * @returns {TransactionOperation&lt;void>}
     *
     * @memberOf TransactionServiceInterpreter
     */
    makeInquiry(key) {
        return (transactionRepo) => __awaiter(this, void 0, void 0, function* () {
            // 取引取得
            return yield transactionRepo.findOne({
                inquiry_key: key,
                status: transactionStatus_1.default.CLOSED
            });
        });
    }
    /**
     * 取引成立
     *
     * @param {string} transactionId
     * @returns {TransactionOperation&lt;void>}
     *
     * @memberOf TransactionServiceInterpreter
     */
    close(transactionId) {
        return (transactionRepo) => __awaiter(this, void 0, void 0, function* () {
            // 取引取得
            const optionTransaction = yield transactionRepo.findById(objectId_1.default(transactionId));
            if (optionTransaction.isEmpty) {
                throw new Error("transaction not found.");
            }
            const transaction = optionTransaction.get();
            // 照会可能になっているかどうか
            if (!transaction.isInquiryAvailable()) {
                throw new Error("inquiry is not available.");
            }
            // 条件が対等かどうかチェック
            if (!transaction.canBeClosed()) {
                throw new Error("transaction cannot be closed.");
            }
            // キューリストを事前作成
            const queues = [];
            transaction.authorizations().forEach((authorization) => {
                queues.push(QueueFactory.createSettleAuthorization({
                    _id: objectId_1.default(),
                    authorization: authorization,
                    status: queueStatus_1.default.UNEXECUTED,
                    run_at: new Date(),
                    max_count_try: 10,
                    last_tried_at: null,
                    count_tried: 0,
                    results: []
                }));
            });
            transaction.notifications().forEach((notification) => {
                queues.push(QueueFactory.createPushNotification({
                    _id: objectId_1.default(),
                    notification: notification,
                    status: queueStatus_1.default.UNEXECUTED,
                    run_at: new Date(),
                    max_count_try: 10,
                    last_tried_at: null,
                    count_tried: 0,
                    results: []
                }));
            });
            // イベント作成
            const event = TransactionEventFactory.create({
                _id: objectId_1.default(),
                group: transactionEventGroup_1.default.CLOSE,
                occurred_at: new Date()
            });
            // 永続化
            const option = yield transactionRepo.findOneAndUpdate({
                _id: objectId_1.default(transactionId),
                status: transactionStatus_1.default.UNDERWAY
            }, {
                $set: {
                    status: transactionStatus_1.default.CLOSED,
                    queues: queues
                },
                $push: {
                    events: event
                }
            });
            if (option.isEmpty) {
                throw new Error("UNDERWAY transaction not found.");
            }
        });
    }
    /**
     * 取引期限切れ
     *
     * @returns {TransactionOperation&lt;void>}
     *
     * @memberOf TransactionServiceInterpreter
     */
    expireOne() {
        return (transactionRepo) => __awaiter(this, void 0, void 0, function* () {
            // イベント作成
            const event = TransactionEventFactory.create({
                _id: objectId_1.default(),
                group: transactionEventGroup_1.default.EXPIRE,
                occurred_at: new Date()
            });
            // 永続化
            yield transactionRepo.findOneAndUpdate({
                status: transactionStatus_1.default.UNDERWAY,
                expired_at: { $lt: new Date() }
            }, {
                $set: {
                    status: transactionStatus_1.default.EXPIRED
                },
                $push: {
                    events: event
                }
            });
            // 永続化結果がemptyの場合は、もう取引中ステータスではないということなので、期限切れタスクとしては成功
        });
    }
    /**
     * キュー出力
     *
     * @param {string} transactionId
     * @returns {TransactionAndQueueOperation&lt;void>}
     *
     * @memberOf TransactionServiceInterpreter
     */
    exportQueues(transactionId) {
        return (transactionRepo, queueRepo) => __awaiter(this, void 0, void 0, function* () {
            const option = yield transactionRepo.findById(objectId_1.default(transactionId));
            if (option.isEmpty) {
                throw new Error("transaction not found.");
            }
            const transaction = option.get();
            let queues;
            switch (transaction.status) {
                // 成立の場合は、あらかじめキューリストが作成されている
                case transactionStatus_1.default.CLOSED:
                    queues = transaction.queues;
                    break;
                // 期限切れの場合は、キューリストを作成する
                case transactionStatus_1.default.EXPIRED:
                    queues = [];
                    transaction.authorizations().forEach((authorization) => {
                        queues.push(QueueFactory.createCancelAuthorization({
                            _id: objectId_1.default(),
                            authorization: authorization,
                            status: queueStatus_1.default.UNEXECUTED,
                            run_at: new Date(),
                            max_count_try: 10,
                            last_tried_at: null,
                            count_tried: 0,
                            results: []
                        }));
                    });
                    // COA本予約があれば取消
                    if (transaction.isInquiryAvailable()) {
                        queues.push(QueueFactory.createDisableTransactionInquiry({
                            _id: objectId_1.default(),
                            transaction_id: transaction._id,
                            status: queueStatus_1.default.UNEXECUTED,
                            run_at: new Date(),
                            max_count_try: 10,
                            last_tried_at: null,
                            count_tried: 0,
                            results: []
                        }));
                    }
                    // TODO おそらく開発時のみ
                    const eventStart = transaction.events.find((event) => (event.group === transactionEventGroup_1.default.START));
                    queues.push(QueueFactory.createPushNotification({
                        _id: objectId_1.default(),
                        notification: NotificationFactory.createEmail({
                            _id: objectId_1.default(),
                            from: "noreply@localhost",
                            to: "hello@motionpicture.jp",
                            subject: "transaction expired",
                            content: `
取引の期限がきれました
_id: ${transaction._id}
created_at: ${(eventStart) ? eventStart.occurred_at : ""}
`
                        }),
                        status: queueStatus_1.default.UNEXECUTED,
                        run_at: new Date(),
                        max_count_try: 10,
                        last_tried_at: null,
                        count_tried: 0,
                        results: []
                    }));
                    break;
                default:
                    throw new Error("transaction group not implemented.");
            }
            const promises = queues.map((queue) => __awaiter(this, void 0, void 0, function* () {
                yield queueRepo.store(queue);
            }));
            yield Promise.all(promises);
        });
    }
    /**
     * メール追加
     *
     * @param {string} transactionId
     * @param {EmailNotification} notification
     * @returns {TransactionOperation&lt;void>}
     *
     * @memberOf TransactionServiceInterpreter
     */
    addEmail(transactionId, notification) {
        return (transactionRepo) => __awaiter(this, void 0, void 0, function* () {
            // イベント作成
            const event = TransactionEventFactory.createNotificationAdd({
                _id: objectId_1.default(),
                occurred_at: new Date(),
                notification: notification
            });
            // 永続化
            const option = yield transactionRepo.findOneAndUpdate({
                _id: objectId_1.default(transactionId),
                status: transactionStatus_1.default.UNDERWAY
            }, {
                $push: {
                    events: event
                }
            });
            if (option.isEmpty) {
                throw new Error("UNDERWAY transaction not found.");
            }
        });
    }
    /**
     * メール削除
     *
     * @param {string} transactionId
     * @param {string} notificationId
     * @returns {TransactionOperation&lt;void>}
     *
     * @memberOf TransactionServiceInterpreter
     */
    removeEmail(transactionId, notificationId) {
        return (transactionRepo) => __awaiter(this, void 0, void 0, function* () {
            // 取引取得
            const optionTransacton = yield transactionRepo.findById(objectId_1.default(transactionId));
            if (optionTransacton.isEmpty) {
                throw new Error("tranasction not found.");
            }
            const transaction = optionTransacton.get();
            const notifications = transaction.notifications();
            const removedNotification = notifications.find((notification) => {
                return (notification._id.toString() === notificationId);
            });
            if (!removedNotification) {
                throw new Error(`notification [${notificationId}] not found in the transaction.`);
            }
            // イベント作成
            const event = TransactionEventFactory.createNotificationRemove({
                _id: objectId_1.default(),
                occurred_at: new Date(),
                notification: removedNotification
            });
            // 永続化
            const option = yield transactionRepo.findOneAndUpdate({
                _id: objectId_1.default(transactionId),
                status: transactionStatus_1.default.UNDERWAY
            }, {
                $push: {
                    events: event
                }
            });
            if (option.isEmpty) {
                throw new Error("UNDERWAY transaction not found.");
            }
        });
    }
    pushAuthorization(transactionId, authorization) {
        return (transactionRepo) => __awaiter(this, void 0, void 0, function* () {
            // イベント作成
            const event = TransactionEventFactory.createAuthorize({
                _id: objectId_1.default(),
                occurred_at: new Date(),
                authorization: authorization
            });
            // 永続化
            const option = yield transactionRepo.findOneAndUpdate({
                _id: objectId_1.default(transactionId),
                status: transactionStatus_1.default.UNDERWAY
            }, {
                $push: {
                    events: event
                }
            });
            if (option.isEmpty) {
                throw new Error("UNDERWAY transaction not found.");
            }
        });
    }
}
Object.defineProperty(exports, "__esModule", { value: true });
exports.default = TransactionServiceInterpreter;
</pre>
    </article>
</section>





		</div>
	</div>

	<div class="clearfix"></div>

	

</div>
</div>


    <div class="modal fade" id="searchResults">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title">Search results</h4>
          </div>
          <div class="modal-body"></div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          </div>
        </div><!-- /.modal-content -->
      </div><!-- /.modal-dialog -->
    </div>


<footer>


<span class="jsdoc-message">
	Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a>
	
		on Sun Feb 12th 2017
	
	using the <a href="https://github.com/docstrap/docstrap">DocStrap template</a>.
</span>
</footer>

<script src="scripts/docstrap.lib.js"></script>
<script src="scripts/toc.js"></script>

    <script type="text/javascript" src="scripts/fulltext-search-ui.js"></script>


<script>
$( function () {
	$( "[id*='$']" ).each( function () {
		var $this = $( this );

		$this.attr( "id", $this.attr( "id" ).replace( "$", "__" ) );
	} );

	$( ".tutorial-section pre, .readme-section pre, pre.prettyprint.source" ).each( function () {
		var $this = $( this );

		var example = $this.find( "code" );
		exampleText = example.html();
		var lang = /{@lang (.*?)}/.exec( exampleText );
		if ( lang && lang[1] ) {
			exampleText = exampleText.replace( lang[0], "" );
			example.html( exampleText );
			lang = lang[1];
		} else {
			var langClassMatch = example.parent()[0].className.match(/lang\-(\S+)/);
			lang = langClassMatch ? langClassMatch[1] : "javascript";
		}

		if ( lang ) {

			$this
			.addClass( "sunlight-highlight-" + lang )
			.addClass( "linenums" )
			.html( example.html() );

		}
	} );

	Sunlight.highlightAll( {
		lineNumbers : true,
		showMenu : true,
		enableDoclinks : true
	} );

	$.catchAnchorLinks( {
        navbarOffset: 10
	} );
	$( "#toc" ).toc( {
		anchorName  : function ( i, heading, prefix ) {
			return $( heading ).attr( "id" ) || ( prefix + i );
		},
		selectors   : "#toc-content h1,#toc-content h2,#toc-content h3,#toc-content h4",
		showAndHide : false,
		smoothScrolling: true
	} );

	$( "#main span[id^='toc']" ).addClass( "toc-shim" );
	$( '.dropdown-toggle' ).dropdown();

    $( "table" ).each( function () {
      var $this = $( this );
      $this.addClass('table');
    } );

} );
</script>



<!--Navigation and Symbol Display-->


<!--Google Analytics-->



    <script type="text/javascript">
        $(document).ready(function() {
            SearcherDisplay.init();
        });
    </script>


</body>
</html>
